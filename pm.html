<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script>const appVersion='v=3';</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PM Tasks • Vytron</title>

  <link rel="stylesheet" href="./styles.css?v=3" />
  <link rel="icon" href="data:,">
</head>
<body>
  <header>
    <a href="./index.html">← Back</a>
    <h2>PM Tasks</h2>
  </header>

  <div class="meta" style="margin:4px 16px 12px">
    Tap <b>Done</b> after weekly bag filter changes or the daily water check (≥3 lines per side).
  </div>
  <main style="max-width:900px;margin:0 auto;padding:0 16px">
    <div id="pmError" class="err"></div>
    <div id="pmList" class="card">Loading…</div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYA7OzOQBpyHsOYIDK89Z4-8BbrRleZ7A",
      authDomain: "vytron-maintenance-app.firebaseapp.com",
      projectId: "vytron-maintenance-app",
      storageBucket: "vytron-maintenance-app.firebasestorage.app",
      messagingSenderId: "951172681125",
      appId: "1:951172681125:web:278450c515a89547f32c4c"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const listEl = document.getElementById("pmList");
    const errEl  = document.getElementById("pmError");

    function nextDueFrom(days){
      const d=new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate() + (Number(days)||0));
      return Timestamp.fromDate(d);
    }
    function toDate(x){ return x?.toDate ? x.toDate() : (x? new Date(x): null); }
    function fmt(x){ const d=toDate(x); return d? d.toLocaleString() : "—"; }
    function status(next){
      if(!next) return ["No schedule",""];
      const today=new Date(); today.setHours(0,0,0,0);
      const due=toDate(next); if(!due) return ["No schedule",""];
      due.setHours(0,0,0,0);
      if(+due < +today) return ["OVERDUE","due"];
      if(+due === +today) return ["Due today","due"];
      return ["OK","ok"];
    }

    async function loadPM(){
      try{
        errEl.textContent=""; listEl.textContent="Loading…";
        const snap = await getDocs(collection(db,"pmTasks"));
        if (snap.empty){ listEl.innerHTML="<p>No PM tasks found.</p>"; return; }

        const items=[]; snap.forEach(s=>{
          const x=s.data();
          items.push({
            id:s.id,
            title:x.title||s.id,
            notes:x.notes||"",
            intervalDays:Number(x.intervalDays)||7,
            lastDone:x.lastDone||null,
            nextDue:x.nextDue||null,
            appliesTo:Array.isArray(x.appliesTo)?x.appliesTo:(x.appliesTo?[x.appliesTo]:[])
          });
        });
        items.sort((a,b)=> (a.nextDue?.toMillis?.()??9e15) - (b.nextDue?.toMillis?.()??9e15));

        listEl.innerHTML = items.map(t=>{
          const [lab,cls]=status(t.nextDue);
          const applies=t.appliesTo.length? t.appliesTo.join(", ") : "All";
          return `
            <div class="card" data-id="${t.id}">
              <div class="row" style="justify-content:space-between">
                <div>
                  <div style="font-weight:700">${t.title}</div>
                  <div class="meta">${t.notes||""}</div>
                  <div class="meta">Last: ${fmt(t.lastDone)} • Next: ${fmt(t.nextDue)}</div>
                  <div class="meta">Interval: ${t.intervalDays}d • Applies: ${applies}</div>
                </div>
                <div class="${cls}" style="align-self:center">${lab}</div>
              </div>
              <div style="margin-top:8px"><button class="btnDone">Done</button></div>
            </div>`;
        }).join("");

        document.querySelectorAll(".btnDone").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const card=btn.closest(".card"); const id=card.dataset.id;
            const item=items.find(x=>x.id===id);
            btn.disabled=true;
            try{
              await updateDoc(doc(db,"pmTasks",id), {
                lastDone: serverTimestamp(),
                nextDue:  nextDueFrom(item.intervalDays)
              });
              await loadPM();
            }catch(e){ errEl.textContent="Update failed: "+(e.message||e); btn.disabled=false; }
          });
        });

      }catch(e){ console.error(e); errEl.textContent="Error: "+(e.message||e); listEl.innerHTML=""; }
    }

    loadPM();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('a[href$=".html"]').forEach(a=>{
        const u=new URL(a.getAttribute('href'), location.href);
        if(!u.search) u.search = appVersion; else u.search += '&'+appVersion;
        a.setAttribute('href', u.pathname + u.search + u.hash);
      });
    });
  </script>
</body>
</html>
