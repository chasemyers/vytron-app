<!doctype html>
<html lang="en">
<head>
  <script>const appVersion='v=3';</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory • Vytron</title>
  <link rel="stylesheet" href="./style.css?v=3" />
  <link rel="icon" href="data:,">
</head>
<body>
  <header>
    <a href="./index.html">← Back</a>
    <h2>Inventory</h2>
  </header>

  <!-- Quick search -->
  <section class="card" style="margin-bottom:12px">
    <div class="grid" style="align-items:end">
      <div>
        <label>Quick search</label>
        <input id="invSearch" placeholder="Name, part #, or location…" />
      </div>
      <div class="right" style="align-self:center">
        <button id="btnClearSearch">Clear</button>
      </div>
    </div>
  </section>

  <!-- Add item -->
  <section class="card" style="margin-bottom:12px">
    <h3 style="margin:0 0 8px">Add item</h3>
    <div class="grid">
      <div><label>Name*</label><input id="add_name" placeholder="e.g. Heat sink" /></div>
      <div><label>Part #</label><input id="add_part" placeholder="PB1013" /></div>
      <div><label>Location</label><input id="add_loc" placeholder="Storeroom B42" /></div>
      <div><label>Qty</label><input id="add_qty" type="number" inputmode="numeric" value="0"/></div>
      <div><label>Min</label><input id="add_min" type="number" inputmode="numeric" value="0"/></div>
    </div>
    <div class="right" style="margin-top:8px">
      <button id="btnAdd" class="primary">Save item</button>
    </div>
    <div id="addMsg" class="meta" style="margin-top:6px"></div>
  </section>

  <!-- List -->
  <div class="card">
    <h3>Items</h3>
    <div id="list">Loading…</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYA7OzOQBpyHsOYIDK89Z4-8BbrRleZ7A",
      authDomain: "vytron-maintenance-app.firebaseapp.com",
      projectId: "vytron-maintenance-app",
      storageBucket: "vytron-maintenance-app.firebasestorage.app",
      messagingSenderId: "951172681125",
      appId: "1:951172681125:web:278450c515a89547f32c4c"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // cache + search
    let invAll = [];
    let searchQ = "";

    const list = document.getElementById("list");
    const $ = id => document.getElementById(id);
    const slug = s => String(s||"").trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");

    async function loadInventory(){
      const snap = await getDocs(collection(db, "inventory"));
      invAll = []; snap.forEach(d => invAll.push({ id:d.id, ...d.data() }));
      renderInventory();
    }

    function matches(it, q){
      if (!q) return true;
      const s=q.toLowerCase();
      return [it.name, it.partNumber, it.location].some(v => (v||"").toLowerCase().includes(s));
    }

    function renderInventory(){
      list.innerHTML = "";
      const rows = invAll.filter(it=>matches(it,searchQ))
                         .sort((a,b)=>(a.name||"").localeCompare(b.name||""));

      if (!rows.length){ list.innerHTML = `<div class="meta">No items match “${searchQ}”.</div>`; return; }

      rows.forEach(it=>{
        const qty = Number(it.qty ?? 0), min = Number(it.minQty ?? 0), low = qty < min;
        const row = document.createElement("div");
        row.className = "item" + (low? " low":"");
        row.dataset.id = it.id;
        row.innerHTML = `
          <span class="name">${it.name || "(unnamed)"} <span class="sku">(${it.partNumber || it.id})</span></span>
          <button data-act="dec">-</button>
          <span class="qty">${qty}</span>
          <button data-act="inc">+</button>
          <span class="min">Min:</span>
          <button data-act="min-dec">-</button>
          <span class="minv">${min}</span>
          <button data-act="min-inc">+</button>
          <span class="meta" style="margin-left:auto">${it.location||''}</span>
        `;
        list.appendChild(row);
      });
    }

    // +/- handlers
    list.addEventListener('click', async (e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const card=btn.closest('.item'); if(!card) return;
      const id=card.dataset.id; const act=btn.dataset.act;
      const ref=doc(db,'inventory',id);

      try{
        if (act==='inc' || act==='dec'){
          const current = Number(card.querySelector('.qty').textContent||0);
          const q = act==='inc' ? current+1 : Math.max(0,current-1);
          await updateDoc(ref,{ qty:q });
          const min = Number(card.querySelector('.minv').textContent||0);
          card.querySelector('.qty').textContent = q;
          card.classList.toggle('low', q < min);
        } else if (act==='min-inc' || act==='min-dec'){
          const current = Number(card.querySelector('.minv').textContent||0);
          const m = act==='min-inc' ? current+1 : Math.max(0,current-1);
          await updateDoc(ref,{ minQty:m });
          const qty = Number(card.querySelector('.qty').textContent||0);
          card.querySelector('.minv').textContent = m;
          card.classList.toggle('low', qty < m);
        }
      }catch(err){ alert('Update failed: '+err.message); }
    });

    // search wiring
    (function(){
      const input = $("invSearch"), clear = $("btnClearSearch");
      let t;
      input?.addEventListener("input", ()=>{
        clearTimeout(t);
        t=setTimeout(()=>{ searchQ=input.value.trim(); renderInventory(); }, 120);
      });
      clear?.addEventListener("click", ()=>{
        searchQ=""; if(input) input.value=""; renderInventory();
      });
    })();

    // add item
    $("btnAdd").addEventListener("click", async ()=>{
      const name = $("add_name").value.trim();
      const part = $("add_part").value.trim();
      const loc  = $("add_loc").value.trim();
      const qty  = parseInt($("add_qty").value||"0",10);
      const min  = parseInt($("add_min").value||"0",10);
      const msg  = $("addMsg");
      if(!name){ msg.textContent="Name is required."; msg.style.color="#f66"; return; }
      try{
        const id = part ? slug(part) : slug(name);
        const ref = doc(db,"inventory",id);
        const existing = await getDoc(ref);
        if (existing.exists()){ msg.textContent=`ID "${id}" already exists.`; msg.style.color="#e6a700"; return; }
        await setDoc(ref,{ name, partNumber:part||"", location:loc||"", qty:isNaN(qty)?0:qty, minQty:isNaN(min)?0:min, notes:"" });
        msg.textContent="Saved."; msg.style.color="#9aa0a6";
        ["add_name","add_part","add_loc"].forEach(i=>$(i).value="");
        $("add_qty").value="0"; $("add_min").value="0";
        await loadInventory();
      }catch(err){ console.error(err); msg.textContent=err.message||"Failed to save."; msg.style.color="#f66"; }
    });

    // initial load
    loadInventory();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('a[href$=".html"]').forEach(a=>{
        const u=new URL(a.getAttribute('href'), location.href);
        if(!u.search) u.search = appVersion; else u.search += '&'+appVersion;
        a.setAttribute('href', u.pathname + u.search + u.hash);
      });
    });
  </script>
</body>
</html>
